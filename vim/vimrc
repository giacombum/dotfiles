" Personal preference .vimrc file
" Maintained by Stefano Zaghi <stefano.zaghi@gmail.com>

" Use vim settings, rather then vi settings (much better!)
" This must be first, because it changes other options as a side effect.
set nocompatible

" Plugins handling with vim-plug {{{
call plug#begin('~/.vim/plugged')
" interface {{{
Plug 'romainl/Apprentice'
Plug 'kien/rainbow_parentheses.vim'
Plug 'majutsushi/tagbar'
Plug 'kien/ctrlp.vim'
Plug 'myusuf3/numbers.vim'
Plug 'bling/vim-airline'
Plug 'paranoida/vim-airlineish'
Plug 'junegunn/limelight.vim'
Plug 'moll/vim-bbye'
Plug 'vasconcelloslf/vim-foldfocus', { 'for':  ['python','fortran'] }
Plug 'chrisbra/NrrwRgn'
" }}}
" utilities {{{
Plug 'csexton/trailertrash.vim'
Plug 'Shougo/neocomplcache.vim'
Plug 'marcweber/vim-addon-mw-utils'
Plug 'garbas/vim-snipmate'
Plug 'vim-scripts/LanguageTool', { 'on':  ['LanguageToolCheck','LanguageToolClear'] }
Plug 'tpope/vim-commentary'
Plug 'tpope/vim-repeat'
Plug 'tpope/vim-obsession'
Plug 'jamessan/vim-gnupg'
Plug 'beloglazov/vim-online-thesaurus', { 'on': ['OnlineThesaurusCurrentWord','Thesaurus'] }
Plug 'deris/vim-rengbang'
Plug 'maksimr/vim-translator', { 'on': 'Translate' }
Plug 'vim-scripts/VisIncr'
Plug 'yaroot/vissort'
Plug 'sk1418/HowMuch', { 'on': 'HowMuch' }
Plug 'godlygeek/tabular'
Plug 'jiangmiao/auto-pairs'
Plug 'airblade/vim-gitgutter'
Plug 'tpope/vim-fugitive'
Plug 'ap/vim-css-color'
Plug 'gorkunov/smartpairs.vim'
" Plug 'Shougo/vimproc.vim', { 'do': 'make' }
" }}}
" filetypes {{{
Plug 'scrooloose/syntastic', { 'for':  ['python','fortran'] }
Plug 'rbonvall/snipmate-snippets-fortran95', { 'for': 'fortran' }
Plug 'honza/vim-snippets', { 'do': 'cd snippets/ ; ln -fs ../../snipmate-snippets-fortran95/snippets/fortran.snippets . ; cd -' }
Plug 'lervag/vim-latex', { 'for': 'tex' }
Plug 'gabrielelana/vim-markdown', { 'for': 'markdown' }
" }}}
call plug#end()
" }}}

" tagbar pluging {{{
let g:tagbar_left = 1
let g:tagbar_width = 30
let g:tagbar_sort = 1
" }}}
"
" syntastic pluging {{{
let g:syntastic_always_populate_loc_list = 1
" }}}

" translators plugin {{{
let g:goog_user_conf={'langpair': 'it|en'}
let g:languagetool_jar='/opt/arch/LanguageTool-2.3/languagetool-commandline.jar'
" }}}

" neocompletecache plugin {{{
  " let g:neocomplete#enable_at_startup = 1
  " Disable AutoComplPop.
  let g:acp_enableAtStartup = 0
  " Use neocomplcache.
  let g:neocomplcache_enable_at_startup = 1
  " Use smartcase.
  let g:neocomplcache_enable_smart_case = 1
  " Set minimum syntax keyword length.
  let g:neocomplcache_min_syntax_length = 3
" }}}

" neosnippet plugin {{{
  " " Plugin key-mappings.
  " imap <C-k>     <Plug>(neosnippet_expand_or_jump)
  " smap <C-k>     <Plug>(neosnippet_expand_or_jump)
  " xmap <C-k>     <Plug>(neosnippet_expand_target)
  " " SuperTab like snippets behavior.
  " imap <expr><TAB> neosnippet#expandable_or_jumpable() ?
  " \ "\<Plug>(neosnippet_expand_or_jump)"
  " \: pumvisible() ? "\<C-n>" : "\<TAB>"
  " smap <expr><TAB> neosnippet#expandable_or_jumpable() ?
  " \ "\<Plug>(neosnippet_expand_or_jump)"
  " \: "\<TAB>"
  " " For snippet_complete marker.
  " if has('conceal')
  "   set conceallevel=2 concealcursor=i
  " endif
  " let g:neosnippet#snippets_directory='~/.vim/plugged/vim-snippets/snippets'
" }}}

" limelight plugin {{{
  autocmd FileType fortran,make,sh,bash,python,c,cpp,vim,css,java,php :Limelight 0.6
" }}}

" Editing behaviour {{{
let mapleader = ","                                                      " leader symbol
set nowrap                                                               " don't wrap lines
set tabstop=2                                                            " a tab is 2 spaces
set softtabstop=2                                                        " when hitting <BS>, pretend like a tab is removed, even if spaces
set expandtab                                                            " expand tabs by default (overloadable per file type later)
set shiftwidth=2                                                         " number of spaces to use for autoindenting
set shiftround                                                           " use multiple of shiftwidth when indenting with '<' and '>'
set backspace=indent,eol,start                                           " allow backspacing over everything in insert mode
set autoindent                                                           " always set autoindenting on
set copyindent                                                           " copy the previous indentation on autoindenting
set number                                                               " always show line numbers
set showmatch                                                            " set show matching parenthesis
set ignorecase                                                           " ignore case when searching
set smartcase                                                            " ignore case if search pattern is all lowercase, case-sensitive otherwise
set smarttab                                                             " insert tabs on the start of a line according to shiftwidth, not tabstop
set scrolloff=4                                                          " keep 4 lines off the edges of the screen when scrolling
set virtualedit=all                                                      " allow the cursor to go in to "invalid" places
set hlsearch                                                             " highlight search terms
set incsearch                                                            " show search matches as you type
set nolist                                                               " don't show invisible characters by default,
set mouse=a                                                              " enable using the mouse if terminal emulator supports it (xterm does)
set formatoptions+=1                                                     " When wrapping paragraphs, don't end lines with 1-letter words (looks stupid)
set encoding=utf-8                                                       " file encoding
set lazyredraw                                                           " don't update the display while executing macros
set laststatus=2                                                         " tell VIM to always put a status line in, even if there is only one window
set cmdheight=2                                                          " use a status bar that is 2 rows high
let g:buftabs_only_basename = 1                                          " show only basename in tabs title
let g:buftabs_marker_modified = "+"                                      " tabs marker
set hidden                                                               " hide buffers instead of closing them this
set switchbuf=useopen                                                    " reveal already opened files from the quickfix window instead of opening new buffers
set nobackup                                                             " do not keep backup files, it's 70's style cluttering
set noswapfile                                                           " do not write annoying intermediate swap files
set viminfo='20,\"80                                                     " read/write a .viminfo file, don't store more than 80 lines of registers
set wildmenu                                                             " make tab completion for files/buffers act like bash
set wildmode=list:full                                                   " show a list when pressing tab and complete first full match
set title                                                                " change the terminal's title
set noerrorbells                                                         " don't beep
set showcmd                                                              " show (partial) command in the last line of the screen
set nomodeline                                                           " disable mode lines (security measure)
"set diffopt+=iwhite                                                      " ignoring trailing white spaces when doing diff
set iskeyword+=:                                                         " turn on the search of keyword
set foldenable                                                           " enable folding
set foldcolumn=1                                                         " add a fold column
set foldmethod=marker                                                    " detect triple-{ style fold markers
set foldlevelstart=0                                                     " start out with everything folded
set foldopen=block,hor,insert,jump,mark,percent,quickfix,search,tag,undo " which commands trigger auto-unfold
set listchars=tab:▸\ ,trail:·,extends:#,nbsp:·                           " characters are not displayed on long lines
set fileformats="unix,dos,mac"                                           " file formats
set termencoding=utf-8                                                   " file encoding
" }}}

" Highlighting and colors {{{
if &t_Co > 2 || has("gui_running")
   syntax on " switch syntax highlighting on, when the terminal has colors
endif
set background=dark
colorscheme apprentice
hi SpellBad term=underline cterm=underline ctermfg=214 ctermbg=16
au VimEnter * RainbowParenthesesToggle
au Syntax * RainbowParenthesesLoadRound
au Syntax * RainbowParenthesesLoadSquare
au Syntax * RainbowParenthesesLoadBraces
let g:airline_theme = 'airlineish'
let g:airline#extensions#tabline#enabled = 1
" }}}

" Filetype specific handling {{{
" Fortran tips {{{
let fortran_fold=1
let fortran_fold_conditionals=1
let s:extfname = expand("%:e")
if s:extfname ==? "f77"
  let g:fortran_fixed_source=1
elseif s:extfname ==? "f"
  let g:fortran_fixed_source=1
else
  let g:fortran_free_source=1
endif
let g:syntastic_fortran_compiler = 'ifort'
let g:syntastic_fortran_compiler_options = '-std03'
" }}}
" sh tips {{{
let sh_fold_enabled=1
" }}}
" xml tips {{{
let xml_syntax_folding=1
" }}}
" LaTeX tips {{{
let g:latex_viewer = 'okular'
  function! SyncTexForward()
    call latex#view('--unique '
      \ . g:latex#data[b:latex.id].out()
      \ . '\#src:' . line(".") . expand('%:p'))
  endfunction
" }}}
" }}}

" Autocommands stuffs {{{
if has("autocmd")
  " positiong the cursor to the last position before closing the file
  autocmd BufReadPost * if line("'\"") > 1 && line("'\"") <= line("$") | exe "normal! g`\"" | endif

  " Don't screw up folds when inserting text that might affect them, until
  " leaving insert mode. Foldmethod is local to the window.
  autocmd InsertEnter * let w:last_fdm=&foldmethod | setlocal foldmethod=manual
  autocmd InsertLeave * let &l:foldmethod=w:last_fdm

  " fobos tips {{{
  autocmd BufEnter,BufRead,BufNewFile *fobos* set syntax=dosini
  " }}}

  " Fortran tips {{{
  let fortran = "$VIM/syntax/fortran.vim"
  " associate *.inc file to fortran type
  autocmd BufEnter,BufRead,BufNewFile *.inc set syntax=fortran
  " marking columns > 132(72)
  autocmd BufEnter,BufRead,BufNewFile *.F,*.FOR,*.FPP,*.F77,*.f,*.for,*.fortran,*.fpp,*.f77 let w:m2=matchadd('ErrorMsg', '\%>72v.\+', -1)
  autocmd BufEnter,BufRead,BufNewFile *.F90,*.F95,*.F03,*.F08,*.f90,*.f95,*.f03,*.f08,*.inc let w:m2=matchadd('ErrorMsg', '\%>132v.\+', -1)
  " fixing indent
  autocmd BufEnter,BufRead,BufNewFile *.F,*.FOR,*.FPP,*.F77,*.f,*.for,*.fortran,*.fpp,*.f77 set tw=72
  autocmd BufEnter,BufRead,BufNewFile *.F90,*.F95,*.F03,*.F08,*.f90,*.f95,*.f03,*.f08,*.inc set tw=132
  " }}}

  " LaTeX tips {{{
  " autocmd FileType tex :call latex#toc#open()
  " }}}

  " programming tips {{{
  " automatically open Tagbar
  autocmd FileType fortran,make,sh,bash,python,c,cpp,vim,css,java,php :TagbarOpen
  if &diff
    autocmd FileType * :TagbarClose
  endif
  " removing trailing space
  autocmd FileType fortran,make,sh,bash,python,c,cpp,tex,vim,css,java,php,xml,markdown autocmd BufWritePre <buffer> :%s/\s\+$//e
  " condensing multiple blank lines into a single blank line
  autocmd FileType fortran,make,sh,bash,python,c,cpp,tex,vim,css,java,php,xml,markdown autocmd BufWritePre <buffer> :%s/\n\{3,}/\r\r/e
  " set fold method to syntax
  autocmd FileType fortran,make,sh,bash,c,cpp,tex,css,java,php,xml,octopress set foldmethod=syntax
  autocmd FileType python set foldmethod=indent foldlevel=0 expandtab tabstop=2 shiftwidth=2 softtabstop=2
  " }}}
endif
" }}}

" Mappings {{{
" Perl/Python regex
nnoremap / /\v
vnoremap / /\v
" Speed up scrolling of the viewport slightly
nnoremap <C-e> 2<C-e>
nnoremap <C-y> 2<C-y>
" change window splits
nnoremap <silent> <A-Up> :wincmd k<CR>
nnoremap <silent> <A-Down> :wincmd j<CR>
nnoremap <silent> <A-Left> :wincmd h<CR>
nnoremap <silent> <A-Right> :wincmd l<CR>
" Map Y do be analog of D
noremap Y y$
" wrap ON/OFF
noremap <F2> :set wrap! wrap?<CR>
" Tagbar
noremap <F3> :TagbarToggle<CR>
" buffer navigation
nnoremap <C-Right> :bnext<CR>
nnoremap <C-Left> :bprevious<CR>
" CtrlP file explorer
nnoremap <C-e> :CtrlP<CR>
" Buffure close
nnoremap qq :Bdelete<CR>
" fold-focusing
nnoremap <C-f> :call FoldFocus('vnew')<CR>
" vim-latex
nnoremap <C-L> :call latex#latexmk#toggle()<CR>
nnoremap <C-T> :call SyncTexForward()<CR>
" cursor movements limited or not (for gigino...)
function! ToggleVirtualedit()
  if &virtualedit != ""
    set virtualedit&
    echo "Cursor movements limited"
  else
    set virtualedit=all
    echo "Cursor movements unlimited"
  endif
endfunction
noremap <C-C> :call ToggleVirtualedit()<CR>
" }}}
